<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Kevin Lanning, Wilkes Honors College" />


<title>Tracking the Novel Coronavirus</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">honors intro data sci</a>
</li>
<li>
  <a href="syllabus.html">syllabus</a>
</li>
<li>
  <a href="schedule.html">schedule</a>
</li>
<li>
  <a href="https://r4ds.had.co.nz/introduction.html">R4DS (Wickham)</a>
</li>
<li>
  <a href="https://kevinlanning.github.io/DataSciLibArts/">dsla (Lanning)</a>
</li>
<li>
  <a href="https://rstudio.cloud/">RStudio Cloud</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Tracking the Novel Coronavirus</h1>
<h4 class="author">Kevin Lanning, Wilkes Honors College</h4>
<h4 class="date">02022020</h4>

</div>


<p>This is an educational script for students learning R with the tidyverse. It reads data provided by the Johns Hopkins Center for Systems Science and Engineering (JHU/CSSE) using the Googlesheets4 package written by Jenny Bryan.</p>
<p>It was modified February 3 because of new GoogleSheet link and altered variable names, on Feb 5 because of a new URL for the data and additional changes in the variable name for date, and Feb 7 to (a) remove need for OAuth and (b) separate Wuhan from other China. On Feb 9, additional data cleaning was performed and interactive plots were added.</p>
<p>```{r setup, message = FALSE} library(googledrive) library(googlesheets4) library(tidyverse) library(magrittr) library(lubridate) library(plotly) library(htmlwidgets) drive_deauth() sheets_deauth() coronaURL &lt;- “<a href="https://docs.google.com/spreadsheets/d/1wQVypefm946ch4XDp37uZ-wartW4V7ILdg-qYiDXUHM" class="uri">https://docs.google.com/spreadsheets/d/1wQVypefm946ch4XDp37uZ-wartW4V7ILdg-qYiDXUHM</a>” nsheets &lt;- sheets_get(as_id(coronaURL)) %&gt;% extract2(6) %&gt;% # gets the sixth element in a list<br />
nrow() # j &lt;- sheets_read(as_id(coronaURL), sheet = i)</p>
<pre><code>
### Reading the data

The Novel Coronavirus data consists of a series of tabs in a Google Sheet. This finds them and combines them into a single sheet in R.

```{r readdata, message = FALSE}
# variables to retain or create
numvars &lt;- c(&quot;Confirmed&quot;, &quot;Deaths&quot;, &quot;Recovered&quot;)
varlist &lt;- c(&quot;Province/State&quot;, &quot;Country/Region&quot;,
             &quot;Last Update&quot;, numvars)
# one cool trick to initialize a tibble
coronaData &lt;- varlist %&gt;%
     map_dfr( ~tibble(!!.x := logical() ) )

# add data from Google sheet to tibble
for (i in 1:(nsheets-1)) {
  j &lt;- sheets_read(as_id(coronaURL), sheet = i)
# if a variable doesn&#39;t exist in sheet, add it
  j[setdiff(varlist,names(j))] &lt;- NA
  j %&lt;&gt;% select(varlist)
  coronaData &lt;- rbind(coronaData, j)
}
# the first (earliest) sheet had different var names
for (i in (nsheets):(nsheets)) {
  j &lt;- sheets_read(as_id(coronaURL), sheet = i) %&gt;%
        mutate(`Last Update` = `Date last updated`)
# if a variable doesn&#39;t exist in sheet, add it
  j[setdiff(varlist,names(j))] &lt;- NA
  j %&lt;&gt;% select(varlist)
  coronaData &lt;- rbind(coronaData, j)
}</code></pre>
<div id="cleaning-wrangling-munging-the-data" class="section level3">
<h3>Cleaning (wrangling, munging) the data</h3>
<p>Cleaning the data includes not just finding “errors,” but adapting it for our own use. It’s generally time consuming, as was the case here. The following letters refer to sections of the code below.</p>
<ul>
<li>a - fix a few missing values outside of China for province and country</li>
<li>b - the earliest cases, all in China, did not include country</li>
<li>c - because province/state is included inconsistently, an unambiguous place variable is created</li>
<li>d - reportdate is renamed (because)</li>
<li>e - in some cases, multiple reports are issued for each day. only the last of these is used for each place.</li>
<li>f - for dates where no data was supplied, the most recent (previous) data are used</li>
<li>g - values of NA for Deaths, Confirmed, and Recovered cases are replaced by zero.</li>
<li>h - Prior to Feb 1, reporting for US included only state, since then, city and state. This drops the (duplicated) province/state-only values beginning Feb 1.</li>
</ul>
<p><code>{r cleaning} coronaData %&lt;&gt;% # a   mutate (`Province/State` = case_when(     (is.na(`Province/State`) &amp;        (`Country/Region` == "Australia")) ~ "New South Wales",     (is.na(`Province/State`) &amp;        (`Country/Region` == "Germany")) ~ "Bavaria",     TRUE ~ `Province/State`)) %&gt;%   mutate (`Country/Region` = case_when(     `Province/State` == "Hong Kong" ~ "Hong Kong",     `Province/State` == "Taiwan" ~ "Taiwan",     `Province/State` == "Washington" ~ "US", # b     is.na (`Country/Region`) ~ "Mainland China",     TRUE ~ `Country/Region`)) %&gt;% # c   mutate(place = ifelse(is.na(`Province/State`),                         `Country/Region`,                         paste0(`Province/State`,", ",                                `Country/Region`))) %&gt;% # d   mutate(reportDate =            date(`Last Update`)) %&gt;%   group_by(place,reportDate) %&gt;% # e   slice(which.max(`Last Update`)) %&gt;%   select(-c(place,`Last Update`)) %&gt;%   ungroup() %&gt;%   # fill in missing dates for each place # f   group_by(place) %&gt;%   complete(reportDate = seq.Date(min(reportDate),                                  today(),                                  by="day")) %&gt;%   fill(c(Confirmed,Deaths,Recovered,          `Country/Region`,`Province/State`)) %&gt;% # g   mutate_if(is.numeric, ~replace_na(., 0)) %&gt;%   ungroup() %&gt;% # h   mutate(dropcase = ((!str_detect(`Province/State`,",")) &amp;                        (reportDate  &gt; "2020-01-31") &amp;                        (`Country/Region` == "Canada" | `Country/Region` == "US"))) %&gt;% # dplyr called explicitly here because plotly has taken over 'filter'   dplyr::filter (!dropcase)</code></p>
</div>
<div id="simplifying-the-data-china-and-the-rest-of-the-world" class="section level3">
<h3>Simplifying the data: China and the rest of the world</h3>
<p>This separates data into three locations, breaking down China into Hubei (Wuhan) and other, then summarizes results:</p>
<p><code>{r threelocations} coronaDataSimple &lt;- coronaData %&gt;%   mutate(country = case_when(     str_detect(`Country/Region`,"China") ~ "China",     TRUE ~ "Other countries")) %&gt;%   mutate(location = case_when(     place == "Hubei, Mainland China" ~ "Hubei (Wuhan)",     country == "China" ~ "Other China",     TRUE ~ "Outside of China")) %&gt;%   group_by(location,reportDate) %&gt;%   summarize(Confirmed = sum(Confirmed),             Deaths = sum(Deaths),             Recovered = sum(Recovered)) %&gt;%   ungroup()</code></p>
</div>
<div id="an-initial-plot" class="section level3">
<h3>An initial plot</h3>
<p>The first plot is simple, including data for only deaths. A caption is added toshow the source of the data.</p>
<p><code>{r simpleplot} myCaption &lt;- " Data courtesy JHU/CSSE http://bit.ly/ncvdata" coronaPlot0 &lt;- coronaDataSimple %&gt;%   ggplot(aes(x=reportDate)) +   geom_line(aes(y=Deaths, color = location)) +   labs(caption = myCaption) coronaPlot0</code></p>
</div>
<div id="adding-recovered-cases" class="section level3">
<h3>Adding recovered cases</h3>
<p>Here, recovered cases and deaths are included (as these are roughly on the same scale). Additional changes are self-evident.</p>
<p><code>{r deathsrecovered} mySubtitle &lt;- paste0(          "Recovered cases (solid line) and deaths (dotted) by region through ",          (month(today())), "/",          (day(today())),"/",          (year(today())),".") myCaption &lt;- " Data courtesy JHU/CSSE http://bit.ly/ncvdata" coronaPlot1 &lt;- coronaDataSimple %&gt;%   ggplot(aes(x=reportDate)) +   geom_line(aes(y=Recovered,                 color = location),             linetype = "solid") +   geom_line(aes(y=Deaths,                 color = location),             linetype = "dotted") +   theme(axis.title.y =         element_text(angle = 90,                      vjust = 1,size = 14),         legend.position = (c(.2,.8))) +   labs(title = "Novel coronavirus",        subtitle = mySubtitle,        y = "Cases",        caption = myCaption) coronaPlot1</code></p>
</div>
<div id="make-the-graph-interactive" class="section level3">
<h3>Make the graph interactive</h3>
<p>Plotly is an open-source, javascript based library that produces interactive graphs. The syntax that Plotly requires is (a little) different from ggplot, so, for example, the subtitle and caption are folded in to the title here, and the legend is moved a little further over.</p>
<p><code>{r confirmed} p &lt;- ggplotly(coronaPlot1) %&gt;%   # make interactive   layout(legend = list(x=.1,y=.9),          title = list(text = paste0('Novel coronavirus',                                     '&lt;br&gt;',                                     '&lt;sup&gt;',                                     mySubtitle,                                     myCaption,                                     '&lt;/sup&gt;'))) saveWidget(p, file="coronaDeathsRecovered.html") p</code></p>
</div>
<div id="plotting-confirmed-cases" class="section level3">
<h3>Plotting confirmed cases</h3>
<p>In this last figure, data for confirmed cases are shown (only the interactive version is included here):</p>
<pre class="{r}"><code>mySubtitle &lt;- paste0(
         &quot;Confirmed cases by region through &quot;,
         (month(today())), &quot;/&quot;,
         (day(today())),&quot;/&quot;,
         (year(today())),&quot;.&quot;)
coronaPlot2 &lt;- coronaDataSimple %&gt;%
  ggplot(aes(x=reportDate)) +
  geom_line(aes(y=Confirmed,
                color = location),
            linetype = &quot;solid&quot;) +
  theme(axis.title.y =
        element_text(angle = 90,
                     vjust = 1,size = 14),
        legend.position = (c(.2,.8))) +
  labs(title = &quot;Novel coronavirus&quot;,
       subtitle = mySubtitle,
       y = &quot;Cases&quot;,
       caption = myCaption)

p &lt;- ggplotly(coronaPlot2) %&gt;%
  # make interactive
  layout(legend = list(x=.1,y=.9),
         title = list(text = paste0(&#39;Novel coronavirus&#39;,
                                    &#39;&lt;br&gt;&#39;,
                                    &#39;&lt;sup&gt;&#39;,
                                    mySubtitle,
                                    myCaption,
                                    &#39;&lt;/sup&gt;&#39;)))
saveWidget(p, file=&quot;coronaConfirmed.html&quot;)
p</code></pre>
</div>
<div id="some-questions" class="section level3">
<h3>Some questions</h3>
<ol style="list-style-type: decimal">
<li>Consider the data and try to run the code yourself.</li>
</ol>
<ul>
<li>What problems did you encounter?</li>
<li>What parts need to be annotated more?</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li><p>Can you reverse-engineer my code? Where is it confusing? (remember the 15 minute rule).</p></li>
<li><p>Can you improve on these plots?</p></li>
<li><p>Some more challenging questions.</p></li>
</ol>
<ul>
<li>What is (roughly) the shape of the function for each of the three variables, and for China/Other?</li>
<li>What values would you expect for, say, ten days from now?</li>
</ul>
</div>
<div id="additional-notes" class="section level3">
<h3>Additional notes</h3>
<p>If you are interested in looking at additional epidemiological datasets and how they might be looked at in R, consider this source by Tomás J. Aragón (<a href="https://bookdown.org/medepi/phds/" class="uri">https://bookdown.org/medepi/phds/</a>). For Plotly in R, check out <a href="https://plotly-r.com/" class="uri">https://plotly-r.com/</a></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
